let monoRoom=null,frame=$('frame'),main=$('main'),rand=$('rand');const wsRoom=location.search.slice(1);wsRoom||(window.location.href='./');var ws=io.connect('https://server.vicklleall.com/mono');function checkUser(){for(let o in monoRoom.u){let e=$(o);e.style.opacity=o===monoRoom.now?1:.5,e.style.zIndex=o===monoRoom.now?11:10}}function start(o,e,t){EST=e,frame.src='./Play.html?'+o,frame.style.pointerEvents='auto',frame.onload=()=>{$('timebar').style.animation=`bar linear ${e}s forwards`;let o=frame.contentWindow;o.$&&(o.$('box').style.display='none',o.$('room').style.width='802px',o.$('room').style.borderRight='1px solid #AAA',frame.clock=setTimeout(()=>$('cls').onclick(),1e3*e))},t&&ws.emit('start',{id:o,t:e})}ws.on('connect',()=>{ws.emit('init',{room:wsRoom,u:currentUser.getUsername()})}).on('crt',o=>{let e=currentUser.getUsername(),t={id:o,u:{},c:{},m:[],now:e};t.u[e]={p:0,n:0},monoRoom=t;for(let o=10;o--;)t.m.push(0);for(let o=30;o--;)t.m.push(1);for(let o=20;o--;)t.m.push(2);for(let o=10;o--;)t.m.push(3);for(let o=30;o--;)t.m.push(4);for(let o=1;o<100;o++){let e=t.m[o],n=100*Math.random()<<0;0!==n&&(t.m[o]=t.m[n],t.m[n]=e)}createMap(),ws.emit('crt',[t,e])}).on('room',o=>{monoRoom=o,createMap(),checkUser()}).on('join',o=>{monoRoom.u[o[0]]={id:o[1],p:0,n:0},showUser(o[0]),addMsg(o[0]+' 进入房间')}).on('move',o=>{let e=$(o.u);monoRoom.u[o.u].p=o.p,e.innerText=o.u+' '+o.p,e.style.left=block[o.n].offsetLeft+33+'px',e.style.top=block[o.n].offsetTop+'px'}).on('count',o=>{o.next!==monoRoom.now&&($('cls').onclick(),monoRoom.u[o.u].p=o.p,updateUser(o.u),monoRoom.now=o.next,rand.on=!1,monoRoom.now===currentUser.getUsername()&&rand.onclick()),checkUser()}).on('msg',addMsg).on('start',o=>{start(o.id,o.t)}).on('leave',o=>{$(o.u).remove(),delete monoRoom.u[o.u],o.next!==monoRoom.now&&($('cls').onclick(),monoRoom.now=o.next,rand.on=!1),checkUser()});const color=['#DDD','#8E8','#EE8','#E88','#8DF','#AAA','#5B5','#BB5','#B55','#5AC','#999','#4A4','#AA4','#A44','#49B'];function createMap(){for(let o=0;o<100;o++)block[o].style.background=color[monoRoom.m[o]],block[o].style.borderColor=color[monoRoom.m[o]+5],block[o].style.color=color[monoRoom.m[o]+10];for(let o in monoRoom.u)showUser(o)}function showUser(o){if($(o))return;let e=document.createElement('div'),t=monoRoom.u[o].n;e.className='user',e.innerText=o+' '+monoRoom.u[o].p,e.id=o,e.style.left=block[t].offsetLeft+33+'px',e.style.top=block[t].offsetTop+'px',main.append(e)}function updateUser(o){$(o).innerText=o+' '+monoRoom.u[o].p}function wait(o){return new Promise((e,t)=>setTimeout(o=>e(o),o,o))}function pushItem(o){let e=document.createElement('div');e.innerText=o.name,$('item').append(e),o.e=e,nowItem.push(o)}function removeItem(){let o=nowItem.shift();o&&o.e.remove()}function GameEnd(o){if(monoRoom.now===currentUser.getUsername()&&o<EST){if(nowItem[0]&&nowItem[0].after&&(nowItem[0].after(),removeItem()),monoRoom.u[monoRoom.now].p+=(o<=EST/2?EST:EST-o<<0)*nowItem.times,updateUser(monoRoom.now),Object.keys(monoRoom.u).length>1){let o=monoRoom.now;monoRoom.now='',ws.emit('count',{u:o,p:monoRoom.u[o].p})}rand.on=!1,nowItem.times=1}}rand.i=6,rand.src='//cdn.jsdelivr.net/gh/vicklleall/website@g3dyb/game/CloudIWanna/img/6.gif',rand.onload=function(){this.i>1?this.src=`//cdn.jsdelivr.net/gh/vicklleall/website@g3dyb/game/CloudIWanna/img/${--this.i}.gif`:this.style.display='block'},rand.onclick=function(){if(this.on||monoRoom.now!==currentUser.getUsername())return;let o=1+6*Math.random()<<0;this.src=`//cdn.jsdelivr.net/gh/vicklleall/website@g3dyb/game/CloudIWanna/img/${o}.gif`,this.on=!0,$('timebar').style.animation='',setTimeout(async()=>{let e=document.getElementsByClassName('block'),t=currentUser.getUsername(),n=$(t);if(monoRoom.u[t].n+=o,monoRoom.u[t].n>99&&(monoRoom.u[t].n-=100),nowItem.times&&(monoRoom.u[t].p+=10*o),updateUser(t),n.style.left=e[monoRoom.u[t].n].offsetLeft+33+'px',n.style.top=e[monoRoom.u[t].n].offsetTop+'px',Object.keys(monoRoom.u).length>1&&ws.emit('move',{u:t,n:monoRoom.u[t].n,p:monoRoom.u[t].p}),await wait(1e3),nowItem[0]&&nowItem[0].pre){let o=nowItem[0].pre();if(0!==o&&removeItem(),o)return}switch(monoRoom.m[monoRoom.u[t].n]){case 0:rand.on=!1,Object.keys(monoRoom.u).length>1&&(monoRoom.now='',ws.emit('count',{u:t,p:monoRoom.u[t].p}));break;case 1:start(GAME[0][Math.random()*GAME[0].length<<0].id,60*nowItem.time,1);break;case 2:start(GAME[1][Math.random()*GAME[1].length<<0].id,120*nowItem.time,1);break;case 3:start(GAME[2][Math.random()*GAME[2].length<<0].id,240*nowItem.time,1);break;case 4:rand.on=!1;let o=ITEM[Math.random()*ITEM.length<<0];if(ws.emit('msg',`${t} 获得 ${o.name}`),addMsg(`${t} 获得 ${o.name}`),o.now){if(o.now())return}else pushItem(o);Object.keys(monoRoom.u).length>1&&(monoRoom.now='',ws.emit('count',{u:t,p:monoRoom.u[t].p})),alert(o.name+': '+o.use)}nowItem.time=1},2e3)},ITEM=[{name:'三倍分数',use:'下一关卡得到的分数翻三倍',after(){return nowItem.times=3}},{name:'过路费',use:'下一关通关前不会得到分数',pre(){return nowItem.times=0},after(){return!0}},{name:'自动完成',use:'下一关卡自动完成并获得全部分数',pre(){let o=currentUser.getUsername(),e=monoRoom.m[monoRoom.u[o].n];switch(e){case 1:case 2:case 3:return ws.emit('msg',o+' 使用 自动完成'),monoRoom.u[o].p+=60*e+(3===e?60:0),Object.keys(monoRoom.u).length>1&&(monoRoom.now='',ws.emit('count',{u:o,p:monoRoom.u[o].p})),updateUser(o),rand.on=!1,!0}}},{name:'双倍时限',use:'下一关卡时限延长到双倍',pre(){let o=currentUser.getUsername(),e=monoRoom.m[monoRoom.u[o].n];1!==e&&2!==e&&3!==e||(ws.emit('msg',o+' 使用 双倍时限'),nowItem.time=2)}},{name:'再来一次',use:'额外一次掷骰子机会',now(){return rand.onclick(),!0}},{name:'奖励100',use:'获得100分',now(){if(!nowItem.times)return;let o=currentUser.getUsername();monoRoom.u[o].p+=100,updateUser(o)}},{name:'奖励500',use:'获得500分',now(){if(!nowItem.times)return;let o=currentUser.getUsername();monoRoom.u[o].p+=500,updateUser(o)}}],nowItem=[],nowItem.times=1,nowItem.time=1,ITEM.forEach(o=>{p=document.createElement('p'),p.innerText=` - ${o.name}: ${o.use}`,$('info').append(p)});let GAME=[[],[],[]],EST=60;function fetchGame(){new AV.Query('Game').select(['RP','R','DP','D']).limit(1e3).find().then(o=>{o.forEach(o=>{if(o.get('DP')){let e=o.get('D')/o.get('DP');GAME[e<25?0:e<50?1:2].push({id:o.id,r:o.get('R')/o.get('RP'),d:e})}})})}fetchGame();let w=20,h=11;for(let o=0;o<100;o++){let e=document.createElement('div');e.className='block',e.innerText=o+1,main.append(e),o<w?e.style.left=66*o+'px':o<w+h?(e.style.top=66*(o-w+1)+'px',e.style.left=66*(w-1)+'px'):o<w+2*h?(e.style.top=66*(w+2*h-o)+'px',e.style.left=66*(w-2)+'px'):o<w+3*h?(e.style.top=66*(o-w-2*h+1)+'px',e.style.left=66*(w-3)+'px'):o<2*w+3*h-6?(e.style.top=66*h+'px',e.style.left=66*(2*w+3*h-4-o)+'px'):o<2*w+4*h-6?(e.style.top=66*(2*w+4*h-6-o)+'px',e.style.left='132px'):o<2*w+5*h-6?(e.style.top=66*(o-2*w-3*h-4)+'px',e.style.left='66px'):o<2*w+6*h-6&&(e.style.top=66*(2*w+6*h-6-o)+'px')}function addMsg(o){let e=document.createElement('p');e.innerText=o,$`msg`.appendChild(e),setTimeout(o=>o.remove(),2e4,e)}block=document.getElementsByClassName('block'),document.addEventListener('keydown',o=>{if(32===o.keyCode){let o=(prompt('请输入要发送的消息：')||'').slice(0,30);o.trim()&&(o=currentUser.getUsername()+': '+o,addMsg(o),ws.emit('msg',o))}}),$('cls').onclick=()=>{if(monoRoom.now===currentUser.getUsername()){if(Object.keys(monoRoom.u).length>1){let o=monoRoom.now;monoRoom.now='',ws.emit('count',{u:o,p:monoRoom.u[o].p})}rand.on=!1}$('timebar').style.animation='none',frame.src='',clearTimeout(frame.clock),frame.style.pointerEvents=''};