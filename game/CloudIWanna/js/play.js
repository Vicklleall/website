currentUser&&($('Player').innerText+=currentUser.getUsername());const GAME_ID=window.location.search.slice(1);ROOM={};let USERS={},nowUser=currentUser.get('username');if(GAME_ID){var query=new AV.Query('Game');query.include(['A','Room']),query.select(['Name','C','RP','R','DP','D','P','I','A.username','Room']),query.get(GAME_ID).then(e=>{GAME=e._serverData,0===GAME.RP?(GAME.R=0,GAME.Ra='---'):(GAME.R=GAME.R/GAME.RP,GAME.Ra=GAME.R.toFixed(1)),0===GAME.DP?GAME.D='??':GAME.D=(GAME.D/GAME.DP).toFixed(1),GAME.A=GAME.A.username,GAME.T=e.createdAt,GAME.Room=void 0,ROOM=e.get('Room')._serverData,ROOM.CT=ROOM.CT||1/0,ROOM.CT>7200&&(ROOM.CT=1/0),ROOM.CD=ROOM.CD||1/0,ROOM.CD>1e3&&(ROOM.CD=1/0),Object.freeze(GAME),Object.freeze(ROOM),GameInit()},e=>{console.log(e)})}function gameC(e){switch(e){case 0:return'Needle';case 1:return'Trap';case 2:return'Gimmick'}}function gameD(e){return`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()} ${cov(e.getHours())}:${cov(e.getMinutes())}:${cov(e.getSeconds())}`}const GameInit=()=>{if(document.title+=` -- ${GAME.Name}`,$('GameName').innerText=GAME.Name,$('Rt').innerText=GAME.Ra,$('RC').style.width=24*(GAME.R<<0)+GAME.R%1*19+3*(GAME.R%1*20>1)+"px",$('Author').innerText=GAME.A,$('In').innerText=GAME.I,$('Dif').innerText=GAME.D,$('Hot').innerText=GAME.P,$('Class').innerText=gameC(GAME.C),$('Date').innerText=gameD(GAME.T),ROOM.CT!==1/0||ROOM.CD!==1/0){var e="<span>üèÖÊåëÊàò:</span>";if(ROOM.CT!==1/0){var t=ROOM.CT%60;e+=`<span>‚è±Ô∏èTime:</span><span>${cov((ROOM.CT-t)/60)+':'+cov(t.toFixed(0))}</span>`}ROOM.CD!==1/0&&(e+=`<span>üíÄDeaths:</span><span>${ROOM.CD}</span>`);var a=$('challenge');a.innerHTML=e,a.style.display='inline-block'}$('warp').style.opacity=1,loadGame()},NtS=e=>String.fromCharCode(e+100),StN=e=>e.charCodeAt()-100,cNum=(e,t)=>t?(e.charCodeAt()-200)/Math.pow(10,t):e.charCodeAt()-200,loadGame=()=>{LOAD();var e=ROOM.R;RoomW=cNum(e.charAt(0)),RoomH=cNum(e.charAt(1)),tiles.width=RoomW,tiles.height=RoomH,ViewX=0,ViewY=0,toVX=0,toVY=0,PViewX=ViewX,PViewY=ViewY,RViewX=0,RViewY=0,BGhspd=0,BGvspd=0,OutMode=0,ViewMode=0;var t=ROOM.T;t&&(Theme=StN(t.charAt(0)),0===Theme?(SprCol=t.slice(1,8),SprCol2=t.slice(8,15),setSprCol(SprCol,SprCol2,0)):1===Theme?(SprCol=t.slice(1,8),SprCol2=SprCol,setSprCol(SprCol,SprCol2,1)):loadSkin(AllTheme[Theme]));var a=ROOM.BG;if(a)if(BackGround=$('back'),sfbg=BackGround.getContext('2d'),BGMode=StN(a.charAt(0)),a=a.slice(1),3===BGMode){let e=a.match(/h-*\d+\.*\d*v-*\d+\.*\d*/);var n=0,r=0;e&&(n=e[0].match(/h-*\d+\.*\d*/)[0].slice(1),r=e[0].match(/v-*\d+\.*\d*/)[0].slice(1));var o=(a=a.replace('url("img',`url("${CDN_src}img`)).match(/url.*\)/);if(BackGround.style.background=o?o[0]:`url(//cdn.jsdelivr.net/gh/vicklleall/website@g3dyb/game/CloudIWanna/img/spr/${a}/BG.png)`,a.match(/\/ \d+px/)){$('C21').click();let e=BackGround.style.background.match(/url.*\)/);e&&(BackGround.style.background=`${e[0]} 0 0 /${RoomW}px ${RoomH}px`),BGhspd=0,BGvspd=0}else{if(a.match(/center/)){let e=BackGround.style.background.match(/url.*\)/);e&&(BackGround.style.background=e[0]+'center no-repeat'),BGhspd=0,BGvspd=0}else{let e=BackGround.style.background.match(/url.*\)/);e&&(BackGround.style.background=e[0]),BGhspd=Number(n),BGvspd=Number(r)}}}else BackGround.style.background=a;try{room_load(!1,!1,!0)}catch(e){console.log(e)}if(BGMid={value:ROOM.BGM},ROOM.E&&''!==ROOM.E){EF[0]=Number(ROOM.E.charAt(0)),EF[7]=Number(ROOM.E.charAt(7));for(let e=1;e<7;e++){var s;switch(e){case 1:case 2:case 6:s=1;break;default:s=.1}EF[e]=StN(ROOM.E.charAt(e))*s}EF[8]=ROOM.E.slice(8)}else EF=[]},loadRoom=()=>{var e=ROOM.R;RoomW=cNum(e.charAt(0)),RoomH=cNum(e.charAt(1)),startX=cNum(e.charAt(2)),startY=cNum(e.charAt(3)),warpEnd=new objWarp(cNum(e.charAt(4)),cNum(e.charAt(5)),!0),OutMode=cNum(e.charAt(6)),ViewMode=cNum(e.charAt(7)),ViewSX=cNum(e.charAt(8)),ViewSY=cNum(e.charAt(9)),readRoom(ROOM)};function loadCheck(){if(Time.start){if(keyboard_check_pressed(vk_shift)||Loading.touch){var e=AV.Object.createWithoutData('Game',GAME_ID);e.increment('P',1),e.save(),oBGM.paused?(oBGM.src=`https://music.163.com/song/media/outer/url?id=${ROOM.BGM}.mp3`,BGMplay.click()):oBGM.currentTime=0,key_clear(vk_right),key_clear(vk_left),key_clear(vk_shift),key_clear(vk_Z),key_clear(vk_S),clearTimeout(ICheck),Loading.style.display='none',Loading.firstChild.innerText='Game Paused',Loading.firstChild.style.fontSize='48px',oTime=new objTime,REC=!0,setInterval(GameRun,20)}}else loadCount===sprNumber&&(Loading.style.backgroundColor='rgba(0,0,0,0.5)',Loading.innerHTML="<pre style='color:#FFF;text-shadow:0 0 5px #000,0 0 10px #000'>Press Shift Key To Start<pre>",Time.time=0,pause=!1,room_load(),key_clear(vk_right),key_clear(vk_left),key_clear(vk_shift),key_clear(vk_Z),key_clear(vk_S),GameRun(),room_load(!0,!0),Time.innerText='00:00.00',Death.innerText='0',Time.start=!0,EF[0]>3&&EFSprinit())}document.addEventListener('keydown',e=>{116===e.keyCode&&e.preventDefault()}),Loading.ontouchstart=()=>Loading.touch=!0,Loading.ontouchend=()=>Loading.touch=!1,ICheck=setInterval(loadCheck,50),UPRK=!1,OnUp=!1;const GameEnd=()=>{END=!0,GO.style.visibility='hidden',GC.style.visibility='visible',GUI.style.transition="opacity 1s 0.4s",GUI.style.visibility='visible',GUI.style.opacity='1',GCobj[0].style.right='420px',GCobj[1].style.left='420px',REP||(currentUser.get("emailVerified")&&(OnUp=!0,UPR(),UPRK=Date.now()),ROOM.CT===1/0&&ROOM.CD===1/0||Time.time<=ROOM.CT&&oTime.getDeaths()<=ROOM.CD&&setTimeout("$('ach').style.top='277px'",2e3),parent&&parent.GameEnd&&parent.GameEnd(Time.time))};function objRank(e){var t={};return t.T=e.T,t.D=e.D,t.P=e.P.get('username'),t.R=e.R,t}var RANK,Rind,upRank;function UPR(){var e=new AV.Query('GRank'),t=AV.Object.createWithoutData('Game',GAME_ID);e.equalTo('G',t),e.include(['P.username','R']),e.find().then(e=>{var a=!1;RANK=[];var n=!1;if(e.forEach((e,t)=>{if(RANK.push(objRank(e._serverData)),e.get('P').id===currentUser.id){if(Rind=t,upRank=e,e.get('T')>Time.time){var r=upRank;r.set('T',Time.time),r.set('D',oTime.getDeaths()),r.set('R',RECO),ROOM.CT===1/0&&ROOM.CD===1/0||(e.get('T')>ROOM.CT||e.get('D')>ROOM.CD)&&Time.time<=ROOM.CT&&oTime.getDeaths()<=ROOM.CD&&(currentUser.increment('Exp',1),currentUser.save()),r.save().then(e=>{RANK[Rind].T=e._serverData.T,RANK[Rind].D=e._serverData.D,loadLB(),OnUp=!1,setTimeout("GCobj[0].style.top='-50px';GCobj[1].style.top='-50px';GCobj[2].style.top='60px'",Math.max(1200-Date.now()+UPRK,0))},e=>{console.log(e)})}else n=!0,OnUp=!1,setTimeout("GCobj[0].style.top='-50px';GCobj[1].style.top='-50px';GCobj[2].style.top='60px'",Math.max(1200-Date.now()+UPRK,0));a=!0}}),a)n&&loadLB();else{upRank=new AV.Object('GRank'),currentUser.increment('Exp',1),ROOM.CT===1/0&&ROOM.CD===1/0||Time.time<=ROOM.CT&&oTime.getDeaths()<=ROOM.CD&&currentUser.increment('Exp',1);var r=upRank;r.set('G',t),r.set('P',currentUser),r.set('T',Time.time),r.set('D',oTime.getDeaths()),r.set('R',RECO),r.save().then(e=>{RANK.push(objRank(e._serverData)),loadLB(),OnUp=!1,setTimeout("GCobj[0].style.top='-50px';GCobj[1].style.top='-50px';GCobj[2].style.top='60px'",Math.max(1200-Date.now()+UPRK,0))},e=>{console.log(e)})}},e=>{console.log(e)})}function stLB(){RANK.sort((e,t)=>e.T-t.T),RANK.forEach((e,t)=>(e.P===currentUser.get('username')&&(Rind=t),!0))}function loadLB(){if(lB.style.display='none','object'==typeof RANK)drawLB();else{var e=new AV.Query('GRank'),t=AV.Object.createWithoutData('Game',GAME_ID);e.equalTo('G',t),e.include(['P.username','R']),e.addAscending('Time'),e.addAscending('Death'),e.find().then(e=>{RANK=[],e.forEach((e,t)=>{RANK.push(objRank(e._serverData)),e.get('P').id===currentUser.id&&(Rind=t)}),drawLB()},e=>{console.log(e)})}}function drawLB(){stLB(),$('RK').innerText=Rind+1;var e="<table><tr><th style='width:120px'>Player</th><th>Time</th><th>Deaths</th><th>Replay</th></tr>";RANK.forEach((t,a)=>{var n='';a===Rind?n=" style='background:hsl(205,100%,95%)'":1&a||(n=" style='background:#F0F2F5'");var r='';a<3&&(r=" style='background:hsl(205,100%,60%)'"),e+=`<tr${n}><td><div class='R' ${r}>${a+1}</div>${t.P}</td><td>${covT(t.T)}</td><td>${t.D}</td><td><span class='rep'>‚ñ∂Ô∏è</span></td></tr>`}),LB.innerHTML=e+'</table>',LB.style.display='block',rep=LB.getElementsByClassName('rep');for(var t=rep.length;t--;)rep[t].ind=t,rep[t].onclick=function(){'none'===Loading.style.display&&('üî≤'===this.innerText?(this.innerText='‚ñ∂Ô∏è',END=!1,REP=!1,REC=!0,keyPause(),UPRK?(room_load(),oTime=new objTime):oTime.resume(),player&&(toVX=Math.max(400,Math.min(player.x,RoomW-400))-400,toVY=Math.max(304,Math.min(player.y,RoomH-304))-304,RViewX=toVX,RViewY=toVY,ViewX=Math.round(RViewX),ViewY=Math.round(RViewY),activate())):REP||(REPIND&&(rep[REPIND].innerText='‚ñ∂Ô∏è'),this.innerText='üî≤',oTime.strep(this)))}}function covT(e){var t=e%60;return cov((e-t)/60)+':'+cov(((100*t<<0)/100).toFixed(2))}GCB=$('gcb'),$('next').onclick=()=>{GCB.style.transform='translateX(-50%) translateY(-50%) scale(1) rotate(360deg)',GCB.children[0].innerText="‚è±Ô∏è Time: "+Time.innerText,GCB.children[1].innerText="üíÄ Deaths: "+Death.innerText},pRB=$('pRB'),pRC=$('pRC'),pRT=$('pRT'),pRB.onmousemove=e=>{var t=Math.ceil((e.offsetX-16)/48);pRC.style.width=48*t+"px",pRT.innerText=t.toFixed(1),uRD.d||'??'===DF.innerText||(uRD.on=!0,uRD.style.color='',uRD.style.backgroundColor='')},DF=$('DF'),DFd=$('DFd'),DFd.on=!1,DFd.style.transition='none',DFd.onmousedown=function(e){this.on=!0,this.dX=e.clientX-this.offsetLeft,this.dY=e.clientY-this.offsetTop},window.onmousemove=e=>{if(DFd.on){var t=Math.min(Math.max(46,e.clientX-DFd.dX),415);DFd.style.left=t+'px',DF.d=(t-46)/3.69,DF.d<20?s=' Very Easy':DF.d<40?s=' Easy':DF.d<60?s=' Medium':DF.d<80?s=' Hard':s=' Very Hard',DF.innerHTML=`${DF.d.toFixed(0)}<span>${s}</span>`,uRD.d||'---'===pRT.innerText||(uRD.on=!0,uRD.style.color='',uRD.style.backgroundColor='')}},window.onmouseup=()=>{DFd.on&&(DFd.on=!1)},uRD=$('uRD'),uRD.on=!1,uRD.d=!1,uRD.style.color='#BBB',uRD.style.backgroundColor='#EEE',uRD.onclick=function(){if(!currentUser.get('emailVerified'))return alert('ÊÇ®ÁöÑË¥¶Âè∑Â∞öÊú™È™åËØÅÔºåÊó†Ê≥ïÁªôÊ∏∏ÊàèËØÑÂàÜ'),!1;if(currentUser.getUsername()===GAME.A)return alert('‰∏çËÉΩÁªôËá™Â∑±ÁöÑ‰ΩúÂìÅËØÑÂàÜÔºÅ'),!1;if(upRank&&void 0!==upRank.get('C'))return alert('ÊÇ®Â∑≤ÁªèÁªôÊ≠§Ê∏∏ÊàèËØÑËøáÂàÜ‰∫ÜÔºÅ'),!1;if(this.on&&!this.d){var e=AV.Object.createWithoutData('Game',GAME_ID);e.increment('R',Number(pRT.innerText)),e.increment('D',Math.round(DF.d)),e.increment('RP',1),e.increment('DP',1),upRank&&(upRank.set('C',Number(pRT.innerText)),upRank.save()),e.set('Index',GAME.T.getTime()+(GAME.R+Number(pRT.innerText))/(GAME.RP+1)*1e8),e.save().then(()=>{alert('Êèê‰∫§ÊàêÂäüÔºÅÊÑüË∞¢ËØÑ‰ª∑„ÄÇ')},e=>{uRD.d=!1,uRD.style.color='',uRD.style.backgroundColor='',alert('Êèê‰∫§Â§±Ë¥•ÔºÅ')}),this.d=!0,this.style.color='#BBB',this.style.backgroundColor='#EEE'}},lB=$('lB'),lB.onclick=loadLB,LB=$('LB'),revt=$('revt'),emoji=$('emoji'),emoji.onclick=()=>{'block'===emojiShow.style.display?emojiShow.style.display='none':emojiShow.style.display='block'},emojiShow=$('emojiShow'),emojiShow.innerHTML='<span>ÔºàÔø£‚ñΩÔø£Ôºâ</span><span>(‚åí‚ñΩ‚åí)</span><span>(ÔΩ•‚àÄÔΩ•)</span><span>(=„Éªœâ„Éª=)</span><span>(„ÄúÔø£‚ñ≥Ôø£)„Äú</span><span>‚Üê‚ó°‚Üê</span><span>("‚ñî‚ñ°‚ñî)/</span><span>ÔºàÔø£„Å∏Ôø£Ôºâ</span><span>(‚ïØ¬∞Âè£¬∞)‚ïØ</span><span>_(:3„Äç‚à†)_</span><span>‚ò∫Ô∏è</span><span>üòÇ</span><span>üòî</span><span>üòß</span><span>üò∂</span><span>üòí</span><span>üò†</span><span>üëç</span><span>üëé</span><span>‚ù§Ô∏è</span><span>‚òï</span>',em=emojiShow.children;for(var i=em.length;i--;)em[i].onclick=function(){revt.value+=this.innerText,revt.oninput()};function loadRV(){lR.style.display='none';var e=new AV.Query('GReview'),t=AV.Object.createWithoutData('Game',GAME_ID);e.equalTo('G',t),e.include('U.username'),e.descending('createdAt'),e.find().then(e=>{SRV.innerHTML='',e.forEach(e=>{var t=e._serverData,a=`${e.createdAt.getFullYear()}-${e.createdAt.getMonth()+1}-${e.createdAt.getDate()} ${cov(e.createdAt.getHours())}:${cov(e.createdAt.getMinutes())}`;SRV.innerHTML+=`<h3>${t.U.get('username')}<span>${a}<span></h3><pre><xmp>${t.W}</xmp></pre>`})},e=>{console.log(e)})}revt.oninput=function(){this.value.length>0?(rev.style.background='',rev.style.borderColor='',rev.style.color='',this.value=this.value.slice(0,200)):(rev.style.background='#EAEAEA',rev.style.borderColor='#EAEAEA',rev.style.color='#AAA')},rev=$('rev'),revt.oninput(),rev.onclick=function(){if(revt.value.length>0&&''===this.style.background){var e=new AV.Object('GReview'),t=AV.Object.createWithoutData('Game',GAME_ID);e.set('G',t),e.set('U',currentUser),e.set('W',revt.value),e.save().then(()=>{revt.value='',revt.oninput(),loadRV()},e=>{})}},SRV=$('SRV'),lR=$('lR'),lR.onclick=loadRV;