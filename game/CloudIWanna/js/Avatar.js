function mouse(e){return e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:{x:e.clientX+document.body.scrollLeft-document.body.clientLeft,y:e.clientY+document.body.scrollTop-document.body.clientTop}}window.onmousemove=e=>{if(e=e||window.event,mouse_x=mouse(e).x,mouse_y=mouse(e).y,void 0!==Cchs.Dw)cGC.sc=Math.max(64,Math.min(dUp.height-Number(Cchs.style.top.slice(0,-2)),dUp.width-Number(Cchs.style.left.slice(0,-2)),mouse_x-Cchs.Dw,mouse_y-Cchs.Dh)),Cchs.style.width=`${cGC.sc}px`,Cchs.style.height=`${cGC.sc}px`;else if(void 0!==Cchs.Dx){var t=mouse_x-Cchs.Dx,s=mouse_y-Cchs.Dy;t=Math.min(dUp.width-Number(Cchs.style.width.slice(0,-2)),Math.max(0,t)),s=Math.min(dUp.height-Number(Cchs.style.height.slice(0,-2)),Math.max(0,s)),Cchs.style.left=`${t}px`,Cchs.style.top=`${s}px`}if(RBar.on){if(RBar.on===RBC[0]){var i=Math.min(Math.max(0,e.clientX-RBar.on.dX),RBC[1].offsetLeft);RG.S=(Math.round(i/180*RBar.w)*RBar.step).toFixed(1/RBar.step>>3)}else{i=Math.min(Math.max(RBC[0].offsetLeft,e.clientX-RBar.on.dX),180);RG.E=(Math.round(i/180*RBar.w)*RBar.step).toFixed(1/RBar.step>>3)}RG.innerText=`${RG.S}~${RG.E}`,RBar.on.style.left=i+'px'}},window.onmouseup=()=>{void 0===Cchs.Dw&&void 0===Cchs.Dx||(cGCc.clearRect(0,0,64,64),cGCc.drawImage(dUp,Number(Cchs.style.left.slice(0,-2)),Number(Cchs.style.top.slice(0,-2)),cGC.sc,cGC.sc,0,0,64,64),Cchs.Dw=void 0,Cchs.Dx=void 0,document.body.style.cursor='default'),RBar.on&&(RBar.on=null)},ipGC=document.createElement('input'),ipGC.type='file',ipGC.accept='image/*',ipGC.style.display='none',cGC=$('cGC'),cGCc=cGC.getContext('2d'),dUp=$('dUp'),dUpc=dUp.getContext('2d'),Cchs=$('Cchs'),Cchs.onmousemove=function(){if(void 0===this.Dw&&void 0===this.Dx){var e=this.getBoundingClientRect();mouse_x>e.right-20&&mouse_y>e.bottom-20?document.body.style.cursor='se-resize':document.body.style.cursor='move'}},Cchs.onmouseout=function(){void 0===this.Dw&&void 0===this.Dx&&(document.body.style.cursor='default')},Cchs.onmousedown=function(){var e=this.getBoundingClientRect();mouse_x>e.right-20&&mouse_y>e.bottom-20?(this.Dw=mouse_x-cGC.sc,this.Dh=mouse_y-cGC.sc,document.body.style.cursor='se-resize'):(this.Dx=mouse_x-Number(this.style.left.slice(0,-2)),this.Dy=mouse_y-Number(this.style.top.slice(0,-2)),document.body.style.cursor='move')},ipGC.onchange=function(){var e=this.files[0],t=new FileReader;t.readAsDataURL(e),t.onload=function(){try{var e=new Image;e.style.imageRendering='auto',e.onload=function(){if(this.width<64||this.height<64)return alert('图片宽高不能小于64像素！'),!1;for(;this.width>1024||this.height>1024;)this.width=this.width>>1,this.height=this.height>>1;dUp.width=this.width,dUp.height=this.height,dUpc.drawImage(this,0,0,dUp.width,dUp.height),cGC.sc=Math.min(dUp.width,dUp.height),Cchs.style.width=`${cGC.sc}px`,Cchs.style.height=`${cGC.sc}px`;var e=(dUp.width-cGC.sc)/2,t=(dUp.height-cGC.sc)/2;Cchs.style.left=`${e}px`,Cchs.style.top=`${t}px`,cGCc.imageSmoothingEnabled=!0,cGCc.imageSmoothingQuality='high',cGCc.clearRect(0,0,64,64),cGCc.drawImage(dUp,e,t,cGC.sc,cGC.sc,0,0,64,64);var s=$('AUp').getElementsByTagName('div');s[0].onclick=()=>{var e=cGC.toDataURL('image/webp',1);e.length>5e3&&(e=cGC.toDataURL('image/webp',.92)),currentUser.set('Avatar',e),currentUser.save().then(()=>{UserPro.style.backgroundImage=`url(${currentUser.get('Avatar')})`,UserPro.firstChild.style.display='none',$('AUp').style.display='none',$('GUI').style.display='none'},()=>{alert('图片上传失败！')})},s[1].onclick=()=>{$('AUp').style.display='none',$('GUI').style.display='none'},$('GUI').style.display='block',$('AUp').style.display='flex'},e.src=this.result}catch(e){console.log(e),alert('文件读取错误！')}}},document.body.appendChild(ipGC);