function FuncLogIn(){currentUser.fetch().then(()=>{sessionStorage.getItem('email')||(currentUser.getEmail()?currentUser.get("emailVerified")||confirm('您的账号尚未验证，是否现在进行邮箱验证？')&&(AV.User.requestEmailVerify(currentUser.getEmail()),alert('已发送验证邮件到您的邮箱，请尽快完成邮箱验证')):($('GUI').style.display='block',$('GUIA').style.display='block',$('Email').style.display='block',alert('在完成账号验证之前，您的账号将受到以下限制：\n-无法发布游戏\n-无法对游戏评分\n-通关记录不会上传至排行榜\n请尽快绑定邮箱以完成账号验证')),sessionStorage.setItem('email',1));var e=currentUser.get('Avatar');e&&(UserPro.firstChild.style.display='none',UserPro.style.backgroundImage=`url(${e})`),$('username').innerText=currentUser.getUsername();var t=currentUser.get('Exp')||0,l=getLv(t),n=t-l.p,s=l.n-l.p,r=n/s*100;$('Exp').innerText=`${n}/${s}`,$('LvS').innerText=`Lv ${l.l}`,$('Bar').style.background=`linear-gradient(90deg,hsl(205,100%,75%) ${r}%,transparent ${r}%)`;var o=currentUser.get('M');if(o&&o.length>0){var i='';o.forEach(e=>{i+=e+'\n'}),alert(i),currentUser.set('M',[]),currentUser.save()}var a=new AV.Query('GRank');a.select('G'),a.equalTo('P',currentUser),a.limit(960),a.find().then(e=>{e.forEach(e=>played.push(e.get('G').id)),GAME.length&&setPlayed()})})}currentUser&&currentUser.isAuthenticated().then(e=>{e?FuncLogIn():window.location.href='./Login'}),UserPro=$('player'),UserPro.onclick=()=>{var e=$('userp');0==e.style.opacity?(e.style.opacity=1,e.style.pointerEvents='auto'):(e.style.opacity=0,e.style.pointerEvents='none')},userb=$('userp').children,userb[0].onclick=()=>{currentUser&&AV.User.logOut(),window.location.href='./Login'},userb[1].onclick=()=>{ipGC.click()},userb[2].onclick=()=>{$('GUI').style.display='block',$('GUIA').style.display='block',$('CUN').style.display='block'},userb[3].onclick=()=>{var e=currentUser.getEmail();e?AV.User.requestPasswordReset(e).then(()=>{alert('请求已发送，请检查您的邮箱！')},e=>{console.log(e),alert('请求发送失败！')}):(alert('请先绑定邮箱！'),$('GUI').style.display='block',$('GUIA').style.display='block',$('Email').style.display='block')},op=document.getElementsByClassName('op'),op[0].onclick=function(){this.style.backgroundColor='hsl(206,100%,85%)',op[1].style.backgroundColor='';var e=$('ga');e.style.opacity=1,e.style.pointerEvents='auto',(e=$('mk')).style.opacity=0,e.style.pointerEvents='none'},op[1].onclick=function(){this.style.backgroundColor='hsl(206,100%,85%)',op[0].style.backgroundColor='';var e=$('ga');e.style.opacity=0,e.style.pointerEvents='none',(e=$('mk')).style.opacity=1,e.style.pointerEvents='auto'};const Lv=[5,10,20,30,40,50,64,80,100,125,150,175,200,225,250,275,300,330,360,400,440,480,520,560,600,640,680,720,760,800,850,900,950,1e3,1060,1120,1200,1280,1360,1440,1500,1600,1700,1800,1900,2e3];function getLv(e){for(i=0;i<Lv.length;i++)if(e<Lv[i])return{l:i,p:Lv[i-1]||0,n:Lv[i]}}function setPlayed(){played.forEach(e=>{var t=$('c'+e);t&&(t.parentNode.parentNode.played=!0,t.style.display='block')}),Filter()}function fetchGame(){if(1!==lastDate){var e=new AV.Query('Game'),t=new AV.Query('Game');if(lastDate){e.lessThan('Index',lastDate),lastDate=1,t.notEqualTo('A',currentUser);var l=AV.Query.and(e,t)}else{lastDate=Date.now()-6e8,e.greaterThan('Index',lastDate),t.equalTo('A',currentUser);l=AV.Query.or(e,t)}l.descending('createdAt'),l.include('A'),l.limit(960),l.select(['Name','C','RP','R','DP','D','P','I','Cover','A.username','Room','hide','Index']),l.find().then(function(e){if(e.length>0){e.forEach(e=>{var t={};t.id=e.id,t.Hide=e.get('hide'),t.N=e.get('Name'),t.C=e.get('C'),t.A=e.get('A').get('username');var l=e.get('RP');if(0===l)t.R=0,t.Ra='---';else{t.R=e.get('R')/l,t.Ra=t.R.toFixed(1);var n=Author.findIndex(e=>e.A===t.A);n<0?Author.push({A:t.A,R:t.R,N:1,T:e.get('A').createdAt}):(Author[n].R+=t.R,Author[n].N+=1)}var s=e.get('DP');t.D=0===s?'??':(e.get('D')/s).toFixed(1),t.P=e.get('P'),t.I=e.get('I'),t.T=e.createdAt,t.Index=2e9*t.R+t.T.getTime(),t.Cover=e.get('Cover'),t.html=document.createElement('div'),t.html.className='game',t.html.id=t.id,t.html.onclick=function(){playGame(this.id)},t.html.innerHTML=`<img width='96' height='96' src='${t.Cover}'/>\n<div class='a'>\n\t<h1>${t.N}</h1><div class='clear' id='c${t.id}'></div>\n\t<span${gameC(t,0)}>Needle</span><span${gameC(t,1)}>Trap</span><span${gameC(t,2)}>Gimmick</span><div class='GI'><div></div></div>\n\t<div class='rating'>${t.Ra}</div>\n\t<div class='raB'></div>\n\t<div class='raC' style='width:${24*(t.R<<0)+t.R%1*19+3*(t.R%1*20>1)}px'></div>\n\t<div class='pa'>\n\t\t<p>作者：${t.A}</p>\n\t\t<p class='in'>难度：${t.D}</p><p class='in r'>人气：${t.P}</p>\n\t\t<p>发布时间：${gameD(t.T)}</p>\n\t</div>\n</div>`;let r=t.html.getElementsByClassName('GI')[0];if(r.firstChild.innerText=t.I,r.onmouseover=function(){this.lastChild.style.opacity=1},r.onmouseout=function(){this.lastChild.style.opacity=0},t.Hide||GAME.push(t),e.get('A').id===currentUser.id){let l=t.html.cloneNode(!0);l.id=t.id,l.innerHTML+="<div class='delg'>删除游戏</div><div class='delg' style='left:50%'>下载游戏</div>";let n=l.getElementsByClassName('delg');n[0].id=t.id,n[1].id=e.get('Room').id,n[1].name=t.N,n[0].onclick=function(){deleteGame(this.id)},n[1].onclick=function(){new AV.Query('GRoom').get(this.id).then(e=>{let t=e._serverData;t.N=this.name,delete t.CT,delete t.CD;let l=document.createElement('a');l.download=this.name+'.iw',l.href=URL.createObjectURL(new Blob([JSON.stringify(t)])),l.click()},e=>{console.log(e),alert('下载失败！')})},MyGame.push(l)}}),loadGAME(),Author.sort((e,t)=>e.T-t.T),Author.sort((e,t)=>t.R/t.N-e.R/e.N),board[2].innerHTML='';for(let e=0;e<15&&Author[e];e++)board[2].innerHTML+=`<div>${e+1}</div><ul><span>${Author[e].A}</span><span style='position:absolute;left:210px'>${(Author[e].R/Author[e].N).toFixed(1)}</span></ul><br/>`;if(MyGame.length>0){$('mk').firstChild.style.marginTop='-120px',$('mk').children[1].style.display='block';var t=$('my');t.style.display='block',MyGame.forEach(e=>{t.appendChild(e)})}$('warp').style.opacity=1,played.length&&setPlayed()}},console.log)}}function gameC(e,t){return e.C===t?" class='l'":''}function cov(e){return e<10?'0'+e:e}function gameD(e){return`${e.getFullYear()}-${cov(e.getMonth()+1)}-${cov(e.getDate())}`}function loadGAME(){gp.innerHTML='';for(var e=0;e<GAME.length;e++)gp.appendChild(GAME[e].html);if(1!==lastDate){var t=document.createElement('div');t.id='more',t.innerText='点击加载更多',t.onclick=function(){1!==lastDate&&(this.innerText='加载中...',fetchGame())},gp.appendChild(t)}}function playGame(e){window.open('./Play?'+e)}GAME=[],Author=[],MyGame=[],lastDate=0,played=[],ga=$('ga'),gp=$('gp'),fetchGame(),board=document.getElementsByClassName('bdarea');var query=new AV.Query('_User');query.descending('Exp'),query.addAscending('createdAt'),query.limit(10),query.select(['username','Exp']),query.find().then(e=>{e.forEach((e,t)=>{board[1].innerHTML+=`<div>${t+1}</div><ul><span>${e.get('username')}</span><span style='position:absolute;left:210px'>Lv.${getLv(e.get('Exp')).l}</span></ul><br/>`})},e=>{console.log(e)}),ps=$('ps').getElementsByClassName('opt'),ps[0].onclick=()=>{GAME.sort((e,t)=>t.T-e.T),loadGAME()},ps[1].onclick=()=>{GAME.sort((e,t)=>t.R===e.R?t.P-e.P:t.R-e.R),loadGAME()},ps[2].onclick=()=>{GAME.sort((e,t)=>t.D-e.D),loadGAME()},ps[3].onclick=()=>{GAME.sort((e,t)=>t.P-e.P),loadGAME()},ps[4].onclick=()=>{GAME.sort((e,t)=>t.Index-e.Index),loadGAME()},RBar=$('RBar'),RG=$('Range'),RG.S=0,RG.E=100,RBC=$('RBar').children,RBC[0].onmousedown=function(e){RBar.on=this,this.dX=e.clientX-this.offsetLeft,this.dY=e.clientY-this.offsetTop},RBC[1].onmousedown=RBC[0].onmousedown,ps[5].S=0,ps[5].E=100,ps[5].txt='难度',ps[5].w=100,ps[5].step=1,ps[6].S=0,ps[6].E=5,ps[6].txt='评分',ps[6].w=50,ps[6].step=.1,ps[5].onclick=function(){$('GUI').style.display='block',$('GUIA').style.display='block',RBar.style.display='block',RBar.w=this.w,RBar.step=this.step,RG.o=this,RG.S=this.S.toFixed(1/RBar.step>>3),RG.E=this.E.toFixed(1/RBar.step>>3),RG.innerText=`${RG.S}~${RG.E}`,RBC[0].style.left=RG.S/RBar.w/RBar.step*180+"px",RBC[1].style.left=RG.E/RBar.w/RBar.step*180+"px"},ps[6].onclick=ps[5].onclick,RGO=document.getElementsByClassName('RGO'),RGO[0].onclick=()=>{RG.o.S=Number(RG.S),RG.o.E=Number(RG.E),RG.o.innerText=`${RG.o.txt} ${RG.S}~${RG.E}`,$('GUI').style.display='none',$('GUIA').style.display='none',RBar.style.display='none',Filter()},Tag=$('Tag').firstChild.children;for(let e=Tag.length;e--;)Tag[e].onclick=function(){this.style.color?this.style.color='':this.style.color='#AAA'};ps[7].onclick=()=>{$('GUI').style.display='block',$('GUIA').style.display='block',$('Tag').style.display='block'},RGO[1].onclick=()=>{if($('GUI').style.display='none',$('GUIA').style.display='none',$('Tag').style.display='none',Tag[0].style.color||Tag[1].style.color||Tag[2].style.color){ps[7].innerText='类型 ';var e=!1;for(let t=0;t<Tag.length;t++)Tag[t].style.color||(e&&(ps[7].innerText+=' &'),ps[7].innerText+=` ${Tag[t].innerText} `,e=!0)}else ps[7].innerText='类型 All';Filter()};var filterClear=0;function Filter(){GAME.forEach(e=>{if('??'===e.D)var t=0;else t=e.D;t>=ps[5].S&&t<=ps[5].E&&e.R>=ps[6].S&&e.R<=ps[6].E&&!Tag[e.C].style.color?(''!==sch.value?e.N.toLowerCase().includes(sch.value.toLowerCase())||e.A.toLowerCase().includes(sch.value.toLowerCase())?e.html.style.display='inline-block':e.html.style.display='none':e.html.style.display='inline-block',1===filterClear?e.html.played&&(e.html.style.display='none'):2===filterClear&&(e.html.played||(e.html.style.display='none'))):e.html.style.display='none'})}ps[8].onclick=()=>{filterClear=1===filterClear?0:1,Filter()},ps[9].onclick=()=>{filterClear=2===filterClear?0:2,Filter()},sch=$('search'),sch.oninput=Filter,EM=$('Email').children,EM[1].oninput=function(){EM[2].innerText='注：邮箱仅用于账号验证和重置密码',EM[2].style.color='',this.style.borderColor=''},RGO[2].onclick=()=>{if(''===EM[1].value)return EM[2].innerText='请输入邮箱地址',EM[2].style.color='#FF4444',EM[1].style.borderColor='#FF4444',!1;currentUser.setEmail(EM[1].value),currentUser.save().then(e=>{alert('已发送验证邮件到您的邮箱，请尽快完成邮箱验证'),$('GUI').style.display='none',$('GUIA').style.display='none',$('Email').style.display='none'},e=>{125==e.code?(EM[2].innerText='邮箱地址无效',EM[2].style.color='#FF4444',EM[1].style.borderColor='#FF4444'):203==e.code?(EM[2].innerText='电子邮箱已被使用',EM[2].style.color='#FF4444',EM[1].style.borderColor='#FF4444'):(EM[2].innerText='邮箱绑定失败',EM[2].style.color='#FF4444')})},RGO[3].onclick=()=>{$('GUI').style.display='none',$('GUIA').style.display='none',$('Email').style.display='none'},RGO[5].onclick=()=>{$('GUI').style.display='none',$('GUIA').style.display='none',$('CUN').style.display='none'},CUN=$('CUN').children,CUN[1].maxLength=20,CUN[1].oninput=function(){CUN[2].innerText='请输入用户名',CUN[2].style.color='',this.style.borderColor=''},RGO[4].onclick=()=>''===CUN[1].value?(CUN[2].innerText='请输入用户名',CUN[2].style.color='#FF4444',CUN[1].style.borderColor='#FF4444',!1):CUN[1].value.length<2?(CUN[2].innerText='2～20字符',CUN[2].style.color='#FF4444',CUN[1].style.borderColor='#FF4444',!1):(currentUser.setUsername(CUN[1].value),void currentUser.save().then(e=>{alert('用户名修改成功！'),$('GUI').style.display='none',$('GUIA').style.display='none',$('CUN').style.display='none'},e=>{202==e.code?(CUN[2].innerText='该用户已存在',CUN[2].style.color='#FF4444',CUN[1].style.borderColor='#FF4444'):(CUN[2].innerText='用户名修改失败',CUN[2].style.color='#FF4444')}));const deleteGame=(e,t="")=>{if(!confirm('确定要删除此游戏吗？\n这会删除此游戏所有数据，玩家已获得的经验也会扣除'))return!1;var l={id:e,inf:t};AV.Cloud.run('delGame',l).then(e=>{alert('删除成功！'),window.location.reload()},e=>{'R'==e.rawMessage?alert('访问遭到拒绝！'):alert('操作失败！')})};function jq(){var e=$('GUI');e.style.display='block',e.style.background='rgba(0,0,0,0.3)',e.onclick=function(){$('GUIB').style.display='none',this.style.background='',this.style.display='none',this.onclick=null},$('GUIB').style.display='block',$('GUIB').firstChild.src='//cdn.jsdelivr.net/gh/vicklleall/website@gbkw8/game/CloudIWanna/img/0.webp'}$('fk').onclick=jq,$('zz').onclick=function(){var e=$('GUI');e.style.display='block',e.style.background='rgba(0,0,0,0.3)',e.onclick=function(){$('GUIC').style.display='none',this.style.background='',this.style.display='none',this.onclick=null},$('GUIC').style.display='block',$('GUIC').style.backgroundImage='url(//cdn.jsdelivr.net/gh/vicklleall/website@gbkw8/game/CloudIWanna/img/1.webp)'};