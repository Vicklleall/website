function room_load(e,o,a){roomInit(),e?loadRoom(a):(RoomW=800,RoomH=608,startX=401,startY=567,warpEnd=new objWarp(384,448,!0),block.push(new objBlock(0,576,800,32))),o||(saveX=startX,saveY=startY,JumpNum=1),blood=null,scrT.clearRect(0,0,tiles.width,tiles.height),edit?player=null:drawInit(),resetPro(),resetGUI(),GCobj[3].style.top='600px',player&&(toVX=Math.max(400,Math.min(player.x,RoomW-400))-400,toVY=Math.max(304,Math.min(player.y,RoomH-304))-304,RViewX=toVX,RViewY=toVY,ViewX=Math.round(RViewX),ViewY=Math.round(RViewY),activate()),shooter.length>9&&(oBGM.currentTime=0)}function loadMap(){window.localStorage[NowGame]&&(saveData=JSON.parse(window.localStorage[NowGame]),room_load(saveData.V,!1,!0))}function evDraw(){if(drawBegin(),edit||drawBGEF(),draw_obj(field),edit?(draw_obj(spike,scr),block.forEach(e=>{'objCrate'!==e.__proto__.constructor.name&&'objBreakableBlock'!==e.__proto__.constructor.name&&e.draw_self()}),draw_obj(Walljump),draw_obj(board)):spike.forEach(e=>{'objSpike'!==e.__proto__.constructor.name&&e.draw_self(scr)}),block.forEach(e=>{'objCrate'!==e.__proto__.constructor.name&&'objBreakableBlock'!==e.__proto__.constructor.name||e.draw_self()}),draw_obj(conveyor),draw_obj(GMStepObj),draw_obj(GMColObj,scr),draw_obj(platform),draw_obj(cherry,scr),draw_obj(bullet,0,!0),edit&&(Rcherry.forEach(e=>e.draw_self()),shooter.forEach(e=>e.draw_self()),scr.drawImage(sprPlayerStart[0],startX-17,startY-23)),draw_obj(objEf,0,!0),player&&(player.draw_self(),px.innerText='x:'+player.x,py.innerText='y:'+player.y.toFixed(2),pa.innerText='align:'+player.x%3),blood){if(blood.length<50)for(var e=5;e--;)blood.push(new objBlood(bloodX,bloodY));blood.forEach(e=>e.draw_self())}if(warpEnd.draw_self(scr),edit&&(scr.strokeStyle='#FFD400'),draw_obj(warp,scr),draw_obj(water),edit){if(canPut){var o=getObjSpr();void 0===o.ang&&(o.ang=0),void 0===o.Ox&&(o.Ox=0),void 0===o.Oy&&(o.Oy=0),void 0===o.sc&&(o.sc=1),o&&(scr.globalAlpha=.5,o.sc<1&&(scr.imageSmoothingEnabled=!0),draw_sprite_angle(scr,o.spr[o.ind||0],mouseX,mouseY,o.ang,o.Ox,o.Oy,o.sc,o.sc),scr.imageSmoothingEnabled=!1,scr.globalAlpha=1)}}else drawEf();if(!edit&&!END){Time.time=(Date.now()-Time.cTime)/1e3;var a=Time.time%60;Time.innerText=cov((Time.time-a)/60)+':'+cov(a<<0)}HBar.style.width=800/RoomW*800+'px',HBar.style.left=9+ViewX/RoomW*800+"px",VBar.style.height=608/RoomH*608+'px',VBar.style.top=39+ViewY/RoomH*608+"px",Gshow.style.backgroundPosition=`${-ViewX}px ${-ViewY}px`}function ProCheck(){if('0px'==tab[2].style.left&&nowObj){if(pObjPro)for(var e=pObjPro.length;e--;)pObjPro[e]!=document.activeElement&&(pObjPro[e].value=nowObj[pObjPro[e].id]);if(scr.strokeStyle='#FFD400',nowObj.drawW)var o=nowObj.cX-nowObj.drawW,a=nowObj.cY-nowObj.drawH,[r,t]=[2*nowObj.drawW,2*nowObj.drawH];else{o=nowObj.x,a=nowObj.y;var[r,t]=[nowObj.w,nowObj.h]}nowObj.Ox&&(o-=nowObj.Ox),nowObj.Oy&&(a-=nowObj.Oy),scr.strokeRect(o,a,r,t),scr.beginPath(),scr.arc(nowObj.x,nowObj.y,1,0,2*PI),scr.arc(nowObj.x,nowObj.y,2,0,2*PI),scr.stroke()}}function UDLR(){if(CreateObj){var e=null;if(keyboard_check_pressed(vk_up)?e='Up':keyboard_check_pressed(vk_down)?e='Down':keyboard_check_pressed(vk_left)?e='Left':keyboard_check_pressed(vk_right)&&(e='Right'),e)switch(CreateObj){case'Spike Up':case'Spike Down':case'Spike Left':case'Spike Right':case'Mini Spike Up':case'Mini Spike Down':case'Mini Spike Left':case'Mini Spike Right':case'Conveyor Up':case'Conveyor Down':case'Conveyor Left':case'Conveyor Right':CreateObj=CreateObj.replace(/Up|Down|Left|Right/g,e)}}}function GameRun(){loadCount>sprNumber+1?(edit||keyDown[82]&&(END&&(Time.time=0,Death.death=0,Death.innerText='0',Time.cTime=Date.now(),END=!1),keyPause(),room_load(!0,!0),keyDown[82]=!1),key_check(vk_right),key_check(vk_left),key_check(vk_up),key_check(vk_down),key_check(vk_shift),key_check(vk_ctrl),key_check(vk_Z),key_check(vk_S),edit||END||(evStep(),BGEF(),evMove()),evDraw(),edit&&(ProCheck(),UDLR()),key_clear(vk_right),key_clear(vk_left),key_clear(vk_up),key_clear(vk_down),key_clear(vk_shift),key_clear(vk_ctrl),key_clear(vk_Z),key_clear(vk_S)):loadCount===sprNumber&&(loadCount=sprNumber+1,OpenGame()),loadCount===sprNumber+82&&(resetSPR(),loadCount=100)}function OpenGame(){Loading.style.display='none',ShowGUI.style.display='block',$('ShowBox').style.display='block',ShowTitle.innerText='打开项目';for(var e='',o=0;o<5;o++)if(localStorage['Game '+o]){if(''===(r=JSON.parse(localStorage['Game '+o])).N)var a='Untitled';else a=r.N;r.V<.4?(localStorage.removeItem('Game '+o),e+="<div class='OpGame'><div>➕ Create A New Game</div></div>"):e+=`<div class='OpGame'><span>⛔</span><div>🔵 ${a}</div></div>`}else e+="<div class='OpGame'><div>➕ Create A New Game</div></div>";BoxCt.innerHTML=e;var r=BoxCt.children;for(o=0;o<r.length;o++){var t=r[o].firstChild;t.ind=o,t.onclick=function(){confirm('⚠️确定要删除此游戏？')&&(window.localStorage.removeItem('Game '+this.ind),OpenGame())},(t=r[o].lastChild).ind=o,t.onclick=function(){NowGame='Game '+this.ind,localStorage[NowGame]?loadMap():(room_load(),ObjT[2].click(),RoomOut[0].click(),GameName.value='',BGMid.value='22776365',BGMid.onchange()),loadCount=100,CloseShow()}}}ObjT[2].click(),ViewX=0,ViewY=0,toVX=0,toVY=0,RViewX=0,RViewY=0,OutMode=0,ViewMode=0,SAVE=void 0,RECT=void 0,SRECT=void 0,END=!1,BGx=0,BGy=0,UDLRObj=[],$('ShowBox').style.display='none',ShowGUI.style.display='block',setInterval(GameRun,20);