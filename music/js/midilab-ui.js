const MidiLab={core:MidiLabCore,ui:{Keyboard:class{static keyA=['KeyQ','Digit2','KeyW','Digit3','KeyE','KeyR','Digit5','KeyT','Digit6','KeyY','Digit7','KeyU','KeyI','Digit9','KeyO','Digit0','KeyP','BracketLeft','Equal','BracketRight','Backspace','Backslash'];static keyB=['KeyZ','KeyS','KeyX','KeyD','KeyC','KeyV','KeyG','KeyB','KeyH','KeyN','KeyJ','KeyM','Comma','KeyL','Period','Semicolon','Slash'];constructor(e){const t=Ele('div','keyboard');t.ap(Ele('div','key-w'),Ele('div','key-b'),Ele('div','key-w'));for(let e=0;e<7;e++){for(let e=0;e<2;e++)t.ap(Ele('div','key-w'),Ele('div','key-b'));t.ap(Ele('div','key-w'));for(let e=0;e<3;e++)t.ap(Ele('div','key-w'),Ele('div','key-b'));t.ap(Ele('div','key-w'))}t.ap(Ele('div','key-w')),e.ap(t),this.container=e,this.key=t.children;for(let e=0;e<this.key.length;e++)this.key[e].keyboard=this,this.key[e].key=e+21,this.key[e].onmousedown=function(){this.aC('on','t-mouse'),this.keyboard.play(this.key)};window.addEventListener('mouseup',()=>{for(const e of c$('t-mouse',t))e.rC('on','t-mouse'),e.keyboard.release(e.key)}),this.keyCode={},this.keyOn={},this.setKeyboardRoot(),window.addEventListener('keydown',e=>{if(!e.repeat)if(/F[1-8]$/.test(e.code)){e.preventDefault();const t=16*e.code[1]-1;for(const e of this.instrument)e.xFade(t)}else{const t=this.keyCode[e.code];t&&!this.keyOn[e.code]&&(this.down(t).aC('t-keyboard'),this.play(t),this.keyOn[e.code]=!0)}}),window.addEventListener('keyup',e=>{const t=this.keyCode[e.code];t&&(this.up(t).rC('t-keyboard'),this.release(t),this.keyOn[e.code]=!1)}),window.addEventListener('blur',()=>{for(const e of Array.from(c$('t-mouse',t)))e.rC('on','t-mouse'),e.keyboard.release(e.key);for(const e of Array.from(c$('t-keyboard',t)))e.rC('on','t-keyboard'),e.keyboard.release(e.key);for(let e in this.keyOn)this.keyOn[e]=!1}),this.instrument=new Set}setKeyboardRoot(e=72,t=60){MidiLab.ui.Keyboard.keyA.forEach((t,o)=>this.keyCode[t]=o+e),MidiLab.ui.Keyboard.keyB.forEach((e,o)=>this.keyCode[e]=o+t)}down(e){const t=this.key[e-21];return t&&t.aC('on'),t}up(e){const t=this.key[e-21];return t&&t.rC('on'),t}play(e){for(const t of this.instrument)t.playNote(e);if(this.flow){const t=this.flow.on[e];t&&(t.on=!1,t.style.height=t.h+'px',t.y-=3e3-t.h),this.flow.on[e]=this.flowNote(e,!0)}}release(e){for(const t of this.instrument)t.releaseNote(e);if(this.flow){const t=this.flow.on[e];t&&(t.on=!1,t.style.height=t.h+'px',t.y-=3e3-t.h,this.flow.on[e]=null)}}addInstrument(e){this.instrument.add(e),e.group.forEach(e=>{for(let t of this.key)e.map[t.key]&&t.aC('actv')})}removeInstrument(e){this.instrument.delete(e);for(let e of this.key)e.rC('actv');for(const e of this.instrument)e.group.forEach(e=>{for(let t of this.key)e.map[t.key]&&t.aC('actv')})}createFlow(){if(!this.flow){this.flow=Ele('div','flow'),this.flow.style.inset='0 0 73px 0',this.container.ap(this.flow),this.flow.x=[],this.flow.w=[],this.flow.spd=1,this.flow.u=[],this.flow.d=[],this.flow.on=[];let e=0;for(let t=0;t<this.key.length;t++){const o=this.key[t].hC('key-b');if(o){let o=3;switch((t-4)%12){case 0:o=3.5;break;case 2:o=2.5;break;case 5:o=4;break;case 9:o=2}this.flow.x.push(e-o)}else this.flow.x.push(e+2),e+=12;this.flow.w.push(o?7:9)}requestAnimationFrame(()=>this.updateFlow())}return this.flow}flowNote(e,t=!1){const o=Ele('div','note');return o.style.left=this.flow.x[e-21]+'px',o.style.width=this.flow.w[e-21]+'px',o.on=t,t?(o.style.bottom=0,o.style.height='3000px',o.h=0,o.y=3e3,this.flow.u.push(o)):this.flow.d.push(o),this.flow.append(o),o}updateFlow(){const e=this.flow.u;this.flow.d;for(let t=e.length;t--;){const o=e[t];o.on&&(o.h+=this.flow.spd),o.y-=this.flow.spd,o.style.transform='translateY('+o.y+'px)',o.y<72-this.container.h&&(o.remove(),e.splice(t,1))}requestAnimationFrame(()=>this.updateFlow())}}}};